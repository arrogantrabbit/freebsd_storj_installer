#!/bin/sh

# PROVIDE: storagenode
# REQUIRE: LOGIN FILESYSTEMS netwait
# KEYWORD: shutdown

. /etc/rc.subr

name="storagenode"
rcvar="${name}_enable"

: ${storagenode_enable:="YES"}
: ${storagenode_user:="storagenode"}
: ${storagenode_executable:="/usr/local/bin/storagenode"}
: ${storagenode_storage_path:="/mnt/storagenode"}
: ${storagenode_config_dir:="${storagenode_storage_path}/config"}
: ${storagenode_identity_dir:="${storagenode_storage_path}/identity/storagenode"}
: ${storagenode_logfile:="/var/log/${name}.log"}

pidfile="/var/run/${name}.pid"
command="/usr/sbin/daemon"

# Verify environment before starting
start_precmd="${name}_prestart"
storagenode_prestart()
{
    # Ensure logfile exists with proper perms
    install -o "${storagenode_user}" -g "${storagenode_user}" -m 644 /dev/null "${storagenode_logfile}"

    # Required directories (must exist and be writable)
    for d in \
        "${storagenode_storage_path}" \
        "${storagenode_storage_path}/blobs" \
        "${storagenode_config_dir}" \
        "${storagenode_identity_dir}"
    do
        if [ ! -d "$d" ] || [ ! -w "$d" ]; then
            err 1 "Required directory '$d' missing or not writable"
        fi
    done
}

command_args="-r -f -H \
  -o ${storagenode_logfile} \
  -P ${pidfile} \
  -u ${storagenode_user} \
  ${storagenode_executable} run \
    --config-dir ${storagenode_config_dir} \
    --identity-dir ${storagenode_identity_dir} \
    --log.output stdout \
    --storage.path ${storagenode_storage_path}"

run_rc_command "$1"
